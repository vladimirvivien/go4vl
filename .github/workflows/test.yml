# .github/workflows/test.yml
name: Tests

on: [push]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Install build dependencies
      run: |
        sudo apt-get update
        # Install linux-headers-generic to get the latest available kernel headers
        sudo apt-get install -y build-essential linux-headers-generic

    - name: Run Unit Tests
      run: go test -v ./v4l2 ./device ./imgsupport

  integration-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Update package cache
      run: sudo apt-get update

    - name: Install build dependencies
      run: |
        # Install linux-headers-generic to get the latest available kernel headers
        sudo apt-get install -y build-essential linux-headers-generic

    - name: Install v4l2 dependencies
      run: |
        sudo apt-get install -y v4l-utils
        # Install v4l2loopback-dkms with fallback
        sudo apt-get install -y v4l2loopback-dkms || echo "v4l2loopback-dkms not available, will try alternative"

    - name: Load v4l2loopback module
      run: |
        # Try to load v4l2loopback if available
        if [ -f /lib/modules/$(uname -r)/extra/v4l2loopback.ko ] || [ -f /lib/modules/$(uname -r)/kernel/drivers/media/v4l/v4l2loopback.ko ]; then
          sudo modprobe v4l2loopback video_nr=10,11 card_label="Test Camera,Test Output"
          v4l2-ctl --list-devices
        else
          echo "v4l2loopback module not available, integration tests may be skipped"
        fi
      continue-on-error: true

    - name: Run Integration Tests
      run: |
        # TestMain will handle v4l2loopback setup automatically
        sudo -E go test -v -tags=integration ./test/... || echo "Integration tests skipped (no v4l2 devices)"
      continue-on-error: true
